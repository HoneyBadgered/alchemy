// This is your Prisma schema file for The Alchemy Table
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication
// ============================================

model User {
  id                       String    @id @default(cuid())
  email                    String    @unique
  password                 String
  username                 String    @unique
  role                     String    @default("user") // user, admin
  emailVerified            Boolean   @default(false)
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  passwordResetToken       String?
  passwordResetExpires     DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  profile                 UserProfile?
  playerState             PlayerState?
  orders                  Order[]
  playerQuests            PlayerQuest[]
  inventory               PlayerInventory[]
  cosmetics               PlayerCosmetics?
  refreshTokens           RefreshToken[]
  orderStatusLogs         OrderStatusLog[]
  cart                    Cart?
  reviews                 Review[]
  wishlistItems           WishlistItem[]
  addresses               Address[]
  paymentMethods          PaymentMethod[]
  rewardPoints            RewardPoints?
  rewardHistory           RewardHistory[]
  subscriptions           Subscription[]
  notificationPreferences NotificationPreference?
  achievements            UserAchievement[]

  @@map("users")
}

model UserProfile {
  id                 String   @id @default(cuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName          String?
  lastName           String?
  avatarUrl          String?
  // Flavor preferences (floral, fruity, earthy, smoky, sweet, herbal)
  flavorPreferences  String[] @default([])
  // Caffeine preference (none, low, medium, high)
  caffeinePreference String?
  // Allergy notes
  allergyNotes       String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("user_profiles")
}

// ============================================
// Address Book
// ============================================

model Address {
  id           String  @id @default(cuid())
  userId       String
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  label        String? // Home, Work, etc.
  firstName    String
  lastName     String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  zipCode      String
  country      String
  phone        String?
  isDefault    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("addresses")
}

// ============================================
// Payment Methods
// ============================================

model PaymentMethod {
  id               String  @id @default(cuid())
  userId           String
  user             User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripePaymentId  String  @unique // Stripe payment method ID
  type             String // card, bank_account, etc.
  last4            String // Last 4 digits
  brand            String? // Visa, Mastercard, etc.
  expirationMonth  Int?
  expirationYear   Int?
  isDefault        Boolean @default(false)
  billingAddressId String? // Optional reference to Address

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("payment_methods")
}

// ============================================
// Rewards & Loyalty
// ============================================

model RewardPoints {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance        Int      @default(0)
  lifetimeEarned Int      @default(0)
  tier           String   @default("Novice") // Novice, Adept, Alchemist, Master, Grandmaster
  tierUpdatedAt  DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("reward_points")
}

model RewardHistory {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String // earned, redeemed, expired, adjusted
  points      Int // Positive for earned, negative for redeemed/expired
  description String
  orderId     String? // Reference to order if applicable
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("reward_history")
}

model Reward {
  id            String   @id @default(cuid())
  name          String
  description   String?
  pointsCost    Int
  discountType  String? // percentage, fixed_amount
  discountValue Decimal? @db.Decimal(10, 2)
  productId     String? // For product-specific rewards
  minimumTier   String   @default("Novice")
  isActive      Boolean  @default(true)
  stock         Int? // Null for unlimited
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("rewards")
}

// ============================================
// Subscriptions
// ============================================

model Subscription {
  id                   String    @id @default(cuid())
  userId               String
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId            String
  name                 String
  frequency            String // weekly, biweekly, monthly, bimonthly
  quantity             Int       @default(1)
  price                Decimal   @db.Decimal(10, 2)
  status               String    @default("active") // active, paused, cancelled
  nextShipmentDate     DateTime?
  lastShipmentDate     DateTime?
  pausedAt             DateTime?
  cancelledAt          DateTime?
  skipNextShipment     Boolean   @default(false)
  stripeSubscriptionId String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

// ============================================
// Notification Preferences
// ============================================

model NotificationPreference {
  id               String  @id @default(cuid())
  userId           String  @unique
  user             User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailEnabled     Boolean @default(true)
  smsEnabled       Boolean @default(false)
  marketingEnabled Boolean @default(true)
  orderUpdates     Boolean @default(true)
  backInStock      Boolean @default(true)
  announcements    Boolean @default(true)
  weeklyDigest     Boolean @default(false)
  phoneNumber      String? // For SMS notifications

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_preferences")
}

// ============================================
// Achievements & Badges
// ============================================

model Achievement {
  id           String   @id @default(cuid())
  name         String   @unique
  description  String
  iconUrl      String?
  category     String // purchase, engagement, social, milestone
  triggerType  String // order_count, total_spent, days_streak, referrals, etc.
  triggerValue Int // Value needed to unlock
  xpReward     Int      @default(0)
  pointsReward Int      @default(0)
  isActive     Boolean  @default(true)
  isSecret     Boolean  @default(false) // Hidden until unlocked
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement  @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  earnedAt      DateTime?    // Null until achievement is earned
  progress      Int          @default(0) // Current progress toward achievement

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("refresh_tokens")
}

// ============================================
// Player Progression
// ============================================

model PlayerState {
  id                String    @id @default(cuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  level             Int       @default(1)
  xp                Int       @default(0)
  totalXp           Int       @default(0)
  currentStreak     Int       @default(0)
  longestStreak     Int       @default(0)
  lastLoginAt       DateTime  @default(now())
  lastDailyRewardAt DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("player_states")
}

// ============================================
// Quests
// ============================================

model Quest {
  id                String   @id @default(cuid())
  name              String
  description       String
  questType         String // daily, weekly, achievement, story
  requiredLevel     Int      @default(1)
  xpReward          Int      @default(0)
  ingredientRewards Json? // Array of {ingredientId, quantity}
  cosmeticRewards   Json? // Array of cosmetic IDs
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  playerQuests PlayerQuest[]

  @@map("quests")
}

model PlayerQuest {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  questId     String
  quest       Quest     @relation(fields: [questId], references: [id], onDelete: Cascade)
  status      String    @default("active") // active, completed, claimed
  progress    Int       @default(0)
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  claimedAt   DateTime?

  @@unique([userId, questId])
  @@map("player_quests")
}

// ============================================
// Inventory & Items
// ============================================

model PlayerInventory {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  itemId    String
  itemType  String // ingredient, blend, consumable
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, itemId])
  @@map("player_inventory")
}

// ============================================
// Recipes & Crafting
// ============================================

model Recipe {
  id            String   @id @default(cuid())
  name          String
  description   String?
  requiredLevel Int      @default(1)
  ingredients   Json // Array of {ingredientId, quantity}
  resultItemId  String
  xpGained      Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("recipes")
}

// ============================================
// Ingredients Management
// ============================================

model Ingredient {
  id               String  @id @default(cuid())
  name             String
  role             String  @default("addIn") // base, addIn, either
  category         String // floral, fruit, herb, spice, tea, sweetener, etc.
  descriptionShort String?
  descriptionLong  String?
  image            String?

  // Flavor & Use
  flavorNotes         String[] @default([])
  cutOrGrade          String? // whole leaf, pieces, powder, crystals, etc.
  recommendedUsageMin Decimal? @db.Decimal(10, 4) // minimum percentage
  recommendedUsageMax Decimal? @db.Decimal(10, 4) // maximum percentage

  // Brewing
  steepTemperature Int? // in Fahrenheit
  steepTimeMin     Int? // in seconds
  steepTimeMax     Int? // in seconds
  brewNotes        String?

  // Inventory & Costing
  supplierId        String?
  supplier          Supplier? @relation(fields: [supplierId], references: [id])
  costPerOunce      Decimal?  @db.Decimal(10, 4)
  costPerGram       Decimal?  @db.Decimal(10, 4) // computed from costPerOunce
  inventoryAmount   Decimal   @default(0) @db.Decimal(10, 2)
  minimumStockLevel Decimal   @default(0) @db.Decimal(10, 2)
  status            String    @default("active") // active, archived, outOfStock

  // Safety
  caffeineLevel String   @default("none") // none, low, medium, high
  allergens     String[] @default([])
  internalNotes String?

  // Legacy fields for compatibility with existing core package
  emoji           String?
  tags            String[] @default([])
  badges          String[] @default([])
  isBase          Boolean  @default(false)
  baseAmount      Decimal? @db.Decimal(10, 2)
  incrementAmount Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Pairing relations
  pairsWith IngredientPairing[] @relation("IngredientPairingSource")
  pairedBy  IngredientPairing[] @relation("IngredientPairingTarget")

  @@index([category])
  @@index([status])
  @@index([supplierId])
  @@map("ingredients")
}

model IngredientPairing {
  id                 String     @id @default(cuid())
  sourceIngredientId String
  sourceIngredient   Ingredient @relation("IngredientPairingSource", fields: [sourceIngredientId], references: [id], onDelete: Cascade)
  targetIngredientId String
  targetIngredient   Ingredient @relation("IngredientPairingTarget", fields: [targetIngredientId], references: [id], onDelete: Cascade)
  createdAt          DateTime   @default(now())

  @@unique([sourceIngredientId, targetIngredientId])
  @@map("ingredient_pairings")
}

model Supplier {
  id          String       @id @default(cuid())
  name        String
  email       String?
  phone       String?
  website     String?
  address     String?
  notes       String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  ingredients Ingredient[]

  @@map("suppliers")
}

// ============================================
// Products & Orders
// ============================================

model Product {
  id                String   @id @default(cuid())
  name              String
  description       String
  price             Decimal  @db.Decimal(10, 2)
  compareAtPrice    Decimal? @db.Decimal(10, 2) // Original price for sale items
  imageUrl          String?
  images            String[] @default([])
  category          String?
  tags              String[] @default([])
  isActive          Boolean  @default(true)
  stock             Int      @default(0)
  lowStockThreshold Int      @default(5) // Threshold for "Low Stock" status
  trackInventory    Boolean  @default(true)
  averageRating     Decimal? @db.Decimal(2, 1) // Cached average rating (e.g., 4.5)
  reviewCount       Int      @default(0) // Cached review count
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  orderItems      OrderItem[]
  cartItems       CartItem[]
  reviews         Review[]
  wishlistItems   WishlistItem[]
  relatedProducts ProductRelation[] @relation("SourceProduct")
  relatedBy       ProductRelation[] @relation("RelatedProduct")
  bundleItems     BundleItem[]

  @@map("products")
}

model Order {
  id                  String   @id @default(cuid())
  userId              String? // Null for guest orders
  user                User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  guestEmail          String? // Email for guest checkout
  sessionId           String? // Session ID for guest checkout
  status              String   @default("pending") // pending, payment_processing, payment_failed, paid, processing, shipped, completed, cancelled
  totalAmount         Decimal  @db.Decimal(10, 2)
  shippingMethod      String?
  shippingCost        Decimal? @db.Decimal(10, 2)
  taxAmount           Decimal? @db.Decimal(10, 2)
  discountCode        String?
  discountAmount      Decimal? @db.Decimal(10, 2)
  customerNotes       String?
  stripePaymentId     String?  @unique // Stripe PaymentIntent ID
  stripePaymentStatus String? // requires_payment_method, requires_confirmation, requires_action, processing, succeeded, canceled
  stripeClientSecret  String? // For frontend Stripe Elements
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  items      OrderItem[]
  labels     LabelDesign[]
  statusLogs OrderStatusLog[]

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int      @default(1)
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  @@map("order_items")
}

// ============================================
// Reviews & Ratings
// ============================================

model Review {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  rating     Int // 1-5 stars
  title      String?
  content    String?
  isVerified Boolean  @default(false) // Verified purchase
  isApproved Boolean  @default(true) // For moderation
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, productId]) // One review per user per product
  @@index([productId])
  @@map("reviews")
}

// ============================================
// Wishlist
// ============================================

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
  @@map("wishlist_items")
}

// ============================================
// Product Bundles & Upsells
// ============================================

model ProductBundle {
  id          String   @id @default(cuid())
  name        String
  description String?
  discount    Decimal  @db.Decimal(5, 2) // Percentage discount for buying bundle
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items BundleItem[]

  @@map("product_bundles")
}

model BundleItem {
  id        String        @id @default(cuid())
  bundleId  String
  bundle    ProductBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  productId String
  product   Product       @relation(fields: [productId], references: [id])
  quantity  Int           @default(1)

  @@unique([bundleId, productId])
  @@map("bundle_items")
}

model ProductRelation {
  id               String   @id @default(cuid())
  sourceProductId  String
  sourceProduct    Product  @relation("SourceProduct", fields: [sourceProductId], references: [id], onDelete: Cascade)
  relatedProductId String
  relatedProduct   Product  @relation("RelatedProduct", fields: [relatedProductId], references: [id], onDelete: Cascade)
  relationType     String // "upsell", "cross-sell", "recommendation"
  sortOrder        Int      @default(0)
  createdAt        DateTime @default(now())

  @@unique([sourceProductId, relatedProductId])
  @@index([sourceProductId])
  @@map("product_relations")
}

// ============================================
// Shopping Cart
// ============================================

model Cart {
  id        String   @id @default(cuid())
  userId    String?  @unique // Null for guest carts
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String?  @unique // For guest cart identification
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@map("cart_items")
}

// ============================================
// Cosmetics (Themes & Skins)
// ============================================

model Theme {
  id              String   @id @default(cuid())
  name            String   @unique
  description     String?
  backgroundUrl   String?
  colorPalette    Json? // Color scheme JSON
  requiredLevel   Int      @default(1)
  requiredQuestId String?
  isPremium       Boolean  @default(false)
  price           Decimal? @db.Decimal(10, 2)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tableSkins TableSkin[]

  @@map("themes")
}

model TableSkin {
  id              String   @id @default(cuid())
  name            String   @unique
  description     String?
  themeId         String
  theme           Theme    @relation(fields: [themeId], references: [id], onDelete: Cascade)
  imageUrl        String?
  requiredLevel   Int      @default(1)
  requiredQuestId String?
  isPremium       Boolean  @default(false)
  price           Decimal? @db.Decimal(10, 2)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("table_skins")
}

model PlayerCosmetics {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  unlockedThemes    String[] // Array of theme IDs
  unlockedSkins     String[] // Array of table skin IDs
  activeThemeId     String?
  activeTableSkinId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("player_cosmetics")
}

// ============================================
// AI-Generated Labels
// ============================================

model LabelDesign {
  id            String   @id @default(cuid())
  orderId       String
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  name          String
  tagline       String
  description   String
  stylePreset   String?
  tonePreset    String?
  artworkPrompt String?
  artworkUrl    String?
  status        String   @default("draft") // draft, approved
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("label_designs")
}

// ============================================
// Events & Analytics
// ============================================

model Event {
  id          String    @id @default(cuid())
  eventType   String // USER_REGISTERED, LEVEL_UP, ORDER_PAID, etc.
  userId      String?
  payload     Json
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([createdAt])
  @@map("events")
}

// ============================================
// Admin - Order Management
// ============================================

model OrderStatusLog {
  id         String   @id @default(cuid())
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  fromStatus String?
  toStatus   String
  changedBy  String? // Null for guest orders
  user       User?    @relation(fields: [changedBy], references: [id])
  notes      String?
  createdAt  DateTime @default(now())

  @@index([orderId])
  @@index([changedBy])
  @@map("order_status_logs")
}

// ============================================
// Admin - Site Configuration
// ============================================

model ShippingMethod {
  id            String   @id @default(cuid())
  name          String   @unique
  description   String?
  price         Decimal  @db.Decimal(10, 2)
  estimatedDays String?
  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("shipping_methods")
}

model TaxRate {
  id        String   @id @default(cuid())
  name      String
  region    String // State, Country, or "Global"
  rate      Decimal  @db.Decimal(5, 4) // e.g., 0.0825 for 8.25%
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([region])
  @@map("tax_rates")
}

model DiscountCode {
  id             String    @id @default(cuid())
  code           String    @unique
  description    String?
  discountType   String // percentage, fixed_amount
  discountValue  Decimal   @db.Decimal(10, 2)
  minOrderAmount Decimal?  @db.Decimal(10, 2)
  maxUses        Int?
  usedCount      Int       @default(0)
  validFrom      DateTime
  validUntil     DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("discount_codes")
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String   @unique // order_confirmation, shipping_notification, etc.
  subject   String
  bodyHtml  String
  bodyText  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_templates")
}

model SiteSettings {
  id          String   @id @default(cuid())
  key         String   @unique // hero_title, hero_subtitle, footer_text, etc.
  value       String
  description String?
  category    String // content, seo, general
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("site_settings")
}

// ============================================
// Stripe Webhooks
// ============================================

model StripeWebhookEvent {
  id          String    @id @default(cuid())
  eventId     String    @unique // Stripe event ID for idempotency
  eventType   String // payment_intent.succeeded, payment_intent.failed, etc.
  payload     Json // Full webhook payload
  processed   Boolean   @default(false)
  processedAt DateTime?
  error       String? // Error message if processing failed
  createdAt   DateTime  @default(now())

  @@index([eventType])
  @@index([processed])
  @@map("stripe_webhook_events")
}
